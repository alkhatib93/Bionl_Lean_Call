// ═══════════════════════════════════════════════════════════════════════════
// Bionl_Lean_Call — Configuration
// ═══════════════════════════════════════════════════════════════════════════

// Import Sarek's base config
includeConfig 'external/sarek/nextflow.config'
includeConfig 'conf/sarek_override.config'

// ═══════════════════════════════════════════════════════════════════════════
// PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════

params {
  // Sarek configuration
  sarek_rev           = "3.5.1"
  sarek_profile       = "docker"
  genome              = "GATK.GRCh38"
  igenomes_ignore     = false
  tools               = "deepvariant"
  skip_tools          = "baserecalibrator"
  save_mapped         = true
  save_output_as_bam  = true
  validate_params     = false

  // VEP / Annotation resources (GCS paths for BioNL)
  vep_cache           = "gs://vep-data-vaic-dammam/vep_data/cache"
  vep_fasta           = "gs://vep-data-vaic-dammam/vep_data/fasta/Homo_sapiens.GRCh38.dna.toplevel.fa"
  revel_vcf           = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/new_tabbed_revel_grch38.tsv.gz"
  alpha_missense_vcf  = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/AlphaMissense_hg38.tsv.gz"
  clinvar_vcf         = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/clinvar.chr.vcf.gz"
  spliceai_snv_vcf    = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/spliceai_scores.masked.snv.hg38.vcf.gz"
  spliceai_indel_vcf  = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/spliceai_scores.masked.indel.hg38.vcf.gz"
  bayesdel_vcf        = "gs://vep-data-vaic-dammam/vep_data/plugins/GRCh38/BayesDel_addAF_GRCh38_complete.txt.gz"
  vep_plugins         = "gs://vep-data-vaic-dammam/vep_plugins"
}

// ═══════════════════════════════════════════════════════════════════════════
// PROCESS DEFAULTS
// ═══════════════════════════════════════════════════════════════════════════

process {
  cpus   = 8
  memory = '4 GB'
  time   = '12h'

  errorStrategy = 'terminate'
  maxRetries    = 4

  publishDir = [
    path    : { "results/${task.process.tokenize(':')[-1].toLowerCase()}" },
    mode    : 'copy',
    enabled : true
  ]
}

// ═══════════════════════════════════════════════════════════════════════════
// EXECUTOR
// ═══════════════════════════════════════════════════════════════════════════

executor {
  name      = 'local'
  queueSize = 100
}

// ═══════════════════════════════════════════════════════════════════════════
// PROFILES (Easy switching between local/BioNL)
// ═══════════════════════════════════════════════════════════════════════════

profiles {
  // Local execution with Conda
  local {
    conda.enabled  = true
    docker.enabled = false
  }

  // BioNL/Standard execution with Docker containers (DEFAULT)
  standard {
    docker.enabled = true
    conda.enabled  = false
    
    process {
      
      // Default container for bcftools processes
      container = 'quay.io/biocontainers/bcftools:1.20--h8b25389_0'
      
      withName: 'VEP_Annotate' {
        container = 'quay.io/biocontainers/ensembl-vep:115.2--pl5321h2a3209d_1'
        memory    = '16 GB'
        cpus      = 4
      }
      
      withName: 'MosdepthRun' {
        container = 'quay.io/biocontainers/mosdepth:0.3.11--h0ec343a_1'
      }
      
      withName: 'LeanReport|GENERATE_ACMG_REPORT' {
        container = 'docker.io/alkhatib93/python-bionl:v1.0'
        memory    = '8 GB'
      }
      
      withName: 'CoverageGapsAnnotation|CoverageSummary' {
        container = 'quay.io/biocontainers/bedtools:2.31.1--hf5e1c6e_2'
      }
      
      withName: 'BedFilterBAM|R1R2Ratio|ForwardReverseRatio|SamtoolsFlagstat|SamtoolsStats|SexCheck' {
        container = 'quay.io/biocontainers/samtools:1.20--h50ea8bc_0'
      }
    }
    
    google {
      project  = 'your-gcp-project-id'  // Update this
      region   = 'europe-west4'
      
      lifeSciences {
        preemptible = true
        bootDiskSize = 20.GB
      }
    }
  }

  // Alias for standard (BioNL) - just uses same config as standard
  bionl {
    docker.enabled = true
    conda.enabled  = false
    
    process {
      
      // Default container for bcftools processes
      container = 'quay.io/biocontainers/bcftools:1.20--h8b25389_0'
      
      withName: 'VEP_Annotate' {
        container = 'quay.io/biocontainers/ensembl-vep:115.2--pl5321h2a3209d_1'
        memory    = '16 GB'
        cpus      = 4
      }
      
      withName: 'MosdepthRun' {
        container = 'quay.io/biocontainers/mosdepth:0.3.11--h0ec343a_1'
      }
      
      withName: 'LeanReport|GENERATE_ACMG_REPORT' {
        container = 'docker.io/alkhatib93/python-bionl:v1.0'
        memory    = '8 GB'
      }
      
      withName: 'CoverageGapsAnnotation|CoverageSummary' {
        container = 'quay.io/biocontainers/bedtools:2.31.1--hf5e1c6e_2'
      }
      
      withName: 'BedFilterBAM|R1R2Ratio|ForwardReverseRatio|SamtoolsFlagstat|SamtoolsStats|SexCheck' {
        container = 'quay.io/biocontainers/samtools:1.20--h50ea8bc_0'
      }
    }
  }

  // Test profile with minimal data
  test {
    params {
      input  = 'data/samplesheet.csv'
      outdir = 'test_results'
      max_cpus   = 2
      max_memory = '6 GB'
      max_time   = '2h'
    }
  }

  // Development profile (faster, less strict)
  dev {
    process.errorStrategy = 'ignore'
    process.maxRetries    = 1
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// RESOURCE LABELS
// ═══════════════════════════════════════════════════════════════════════════

process {
  withLabel: process_low {
    cpus   = 2
    memory = '4 GB'
    time   = '4h'
  }
  
  withLabel: process_medium {
    cpus   = 8
    memory = '16 GB'
    time   = '12h'
  }
  
  withLabel: process_high {
    cpus   = 16
    memory = '32 GB'
    time   = '24h'
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// PLUGINS
// ═══════════════════════════════════════════════════════════════════════════

plugins {
  id 'nf-schema@2.4.0'
}

// ═══════════════════════════════════════════════════════════════════════════
// REPORTING
// ═══════════════════════════════════════════════════════════════════════════

report {
  enabled   = true
  file      = 'results/pipeline_report.html'
  overwrite = true
}

timeline {
  enabled   = true
  file      = 'results/timeline_report.html'
  overwrite = true
}

trace {
  enabled   = true
  file      = 'results/trace.txt'
  overwrite = true
  fields    = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
  enabled   = true
  file      = 'results/pipeline_dag.html'
  overwrite = true
}

// ═══════════════════════════════════════════════════════════════════════════
// MANIFEST
// ═══════════════════════════════════════════════════════════════════════════

manifest {
  name            = 'Bionl_Lean_Call'
  author          = 'Bionl'
  homePage        = 'https://github.com/alkhatib93/Bionl_Lean_Call'
  description     = 'Germline ACMG Secondary Findings variant calling and annotation pipeline'
  mainScript      = 'main.nf'
  nextflowVersion = '!>=23.04.0'
  version         = '1.0.0'
  doi             = ''
}